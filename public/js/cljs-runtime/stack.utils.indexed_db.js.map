{"version":3,"sources":["stack/utils/indexed_db.cljs"],"mappings":"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","names":["stack.utils.indexed-db/create-upgrade-handler","id","schema-version","on-upgrade","e","__run-fn-form","__kind","__ns","__id","__level","sf","taoensso.telemere.impl/*rt-sig-filter*","__inst","js/Date","__thread","__root0","taoensso.telemere.impl/*trace-root*","__otel-context1","__uid","__root1","__run-result","signal__42289__auto__","cljs.core/Delay","signal__42280__auto__","taoensso.telemere.impl/Signal","taoensso.telemere/*ctx*","taoensso.telemere.impl/*trace-parent*","temp__5821__auto__","taoensso.telemere/*middleware*","sig-middleware__42281__auto__","taoensso.telemere.impl/dispatch-signal!","taoensso.telemere.impl/WrappedSignal","stack.utils.events/extract-result","G__89503","stack.utils.indexed-db/create-blocked-handler","idb-conn-atom","_e","cljs.core/deref","stack.utils.indexed-db/create-open-handler","on-open","idb-conn","cljs.core/reset!","var_args","args__5732__auto__","len__5726__auto__","i__5727__auto__","argseq__5733__auto__","cljs.core/IndexedSeq","stack.utils.indexed-db/open","p__89525","map__89526","cljs.core/--destructure-map","cljs.core.get","seq89517","G__89518","cljs.core/first","cljs.core/next","G__89519","self__5711__auto__","js/window","cljs.core/clj->js","p1__89516#","stack.utils.events/add-listener","stack.utils.indexed-db/add","store-id","data","stack.utils.indexed-db/get-all","p__89553","map__89554","seq89550","G__89551","G__89552","then","cljs.core.js__GT_clj","G__89556"],"sourcesContent":["(ns stack.utils.indexed-db\n  (:require\n   [taoensso.telemere :as t]\n   [stack.utils.events :as events]))\n\n;; See https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB\n;; This wraps indexed-db in a promise-based API - may be helpful? https://github.com/jakearchibald/idb\n\n(defn- create-upgrade-handler [id schema-version on-upgrade]\n  (fn [e]\n    (t/event! ::create-or-upgrade {:level :warn :data {:id id :schema-version schema-version}})\n    (-> (events/extract-result e)\n        (on-upgrade))))\n\n(defn- create-blocked-handler [idb-conn-atom id]\n  (fn [_e]\n    (t/event! ::connection-blocked {:level :warn :data id})\n    (.close @idb-conn-atom)))\n\n(defn- create-open-handler [idb-conn-atom id on-open]\n  (fn [e]\n    (t/event! ::connection-opened {:data id})\n    (let [idb-conn (events/extract-result e)]\n      (reset! idb-conn-atom idb-conn)\n      (when on-open\n        (on-open idb-conn)))))\n\n(defn open [idb-conn-atom id & {:keys [schema-version on-upgrade on-open] :or {schema-version 1 on-open nil}}]\n  (t/event! ::open-connection {:data {:id id :schema-version schema-version}})\n  (-> js/window\n      (.-indexedDB)\n      (.open id (clj->js schema-version))\n      (events/add-listener \"error\" #(t/event! ::open-error {:data {:id id :error %}}))\n      (events/add-listener \"blocked\" (create-blocked-handler idb-conn-atom id))\n      (events/add-listener \"upgradeneeded\" (create-upgrade-handler id schema-version on-upgrade))\n      (events/add-listener \"success\" (create-open-handler idb-conn-atom id on-open))))\n\n\n(defn add [idb-conn store-id data]\n  (t/event! ::add {:level :debug :data {:id (.-name idb-conn) :store store-id :data data}})\n  (-> (.transaction idb-conn [store-id] \"readwrite\")\n      (.objectStore store-id)\n      (.add (clj->js data))\n      (events/add-listener \"success\" #(t/event! ::add-ok {:level :debug :data {:id (.-name idb-conn) :store store-id}}))))\n\n\n(defn get-all [idb-conn store-id & {:keys [then]}]\n  (-> (.transaction idb-conn [store-id] \"readonly\")\n      (.objectStore store-id)\n      (.getAll)\n      (events/add-listener\n       \"success\"\n       (fn [e]\n         (-> (events/extract-result e)\n             (js->clj :keywordize-keys true)\n             (then))))))\n"]}